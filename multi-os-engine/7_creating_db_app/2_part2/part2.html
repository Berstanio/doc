

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Working with Persistent Storage Using the Multi-OS Engine Technology Preview - Part 2 &mdash; Multi-OS Engine Documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="Multi-OS Engine Documentation" href="../../../index.html"/>
        <link rel="up" title="Creating a Database App" href="../creating_db_app.html"/>
        <link rel="next" title="Accessing Web Services" href="../../8_accessWebServices/accessWebServices.html"/>
        <link rel="prev" title="Working with Persistent Storage Using the Multi-OS Engine Technology Preview - Part 1" href="../1_part1/part1.html"/>
     
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-75001976-1', 'auto');
  ga('send', 'pageview');

</script>


  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> Multi-OS Engine Documentation
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../../MultiOSEngine.html">Multi-OS Engine</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../1_Overview/Overview.html">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../2_Introduction/Introduction.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../3_getting_started/Getting_Started.html">Getting Started</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../4_create_ui/create_ui.html">Creating Your App&#8217;s User Interface (UI)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../5_using_thirdparty/using_thirdparty.html">Using Third Party Native Libraries for iOS*</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../6_natj/NatJ.html">Nat/J library for Java to native binding</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../creating_db_app.html">Creating a Database App</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../1_part1/part1.html">Working with Persistent Storage Using the Multi-OS Engine Technology Preview - Part 1</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="">Working with Persistent Storage Using the Multi-OS Engine Technology Preview - Part 2</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#ios-specific-code">iOS Specific Code</a></li>
<li class="toctree-l4"><a class="reference internal" href="#android-specific-code">Android Specific Code</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../8_accessWebServices/accessWebServices.html">Accessing Web Services</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../9_game/game.html">Creating a Game App</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../12_advanced/advanced.html">Advanced Topics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../13_Troubleshooting/troubleshooting.html">Troubleshooting tips</a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../../index.html">Multi-OS Engine Documentation</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../../MultiOSEngine.html">Multi-OS Engine</a> &raquo;</li>
      
          <li><a href="../creating_db_app.html">Creating a Database App</a> &raquo;</li>
      
    <li>Working with Persistent Storage Using the Multi-OS Engine Technology Preview - Part 2</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="working-with-persistent-storage-using-the-multi-os-engine-technology-preview-part-2">
<h1>Working with Persistent Storage Using the Multi-OS Engine Technology Preview - Part 2<a class="headerlink" href="#working-with-persistent-storage-using-the-multi-os-engine-technology-preview-part-2" title="Permalink to this headline">¶</a></h1>
<p>This is the second part of a two-part tutorial that shows how to do persistent storage in Apple iOS* with Java* using Intel’s Multi-OS Engine Technology Preview. This part adds SQLite* functionality to our app created using the first tutorial part.</p>
<p>We will show how to use SQLite library using the Multi-OS Engine for both Android* and iOS by generating bindings for the sqlite.h file and how to access them. The first part of this tutorial can be found here. Building on the app from part 1, download sqlite3.h from the SQLite website and copy it to our common library directory.</p>
<img alt="../../../_images/part21.png" src="../../../_images/part21.png" />
<p>To generate Java bindings from C header files, click the Generate Bindings button as shown.</p>
<img alt="../../../_images/part22.png" src="../../../_images/part22.png" />
<p>The Multi-OS Engine creates a new directory to contain all the NatJ bindings related to the SQLite. We will use these bindings to create database instance and run our database CRUD operations common to both platforms.</p>
<img alt="../../../_images/part23.png" src="../../../_images/part23.png" />
<p>Here we will add an annotation &#64;Library(&#8220;sqlite3&#8221;) to our generated class file. The &#64;Library annotation specifies the name of the native library that needs to be loaded for the marked class to work. More specifically, when NatJ.register() is invoked, NatJ will search for this annotation in the invoker class, and try to load the specified library with NatJ.lookUpLibrary(...).</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>@Library(&quot;sqlite3&quot;)
@Runtime(CRuntime.class)
public final class Globals {
static {
        NatJ.register();
}
</pre></div>
</div>
<p>Also, we need the Multi-OS Engine&#8217;s NatJ bindings to access native C pointers. To do this, add natj-api.jar library as dependency to the common library folder. This jar can be found in the GitHub* project and you can directly import it into your project.</p>
<p>Next, we create a Note class that will be our data model for the database.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>public class Note implements Comparable&lt;Note&gt;{
private Integer id;
        private String note;
public void setId(int i){
        id =i;
}
public Integer getId(){
        return id;
}
public void setNote(String s){
        note = s;
}
public String getNote(){
        return note;
}
@Override
public int compareTo(Note o) {
        return this.id.compareTo(o.id);
}
}
</pre></div>
</div>
<p>Now let’s create common code to create and manage the database and to store the note contents.</p>
<p>SQLiteDatabaseHelper.java is used to open and close database instance. In its constructor directory path of the database file is passed which will be platform specific. Its onCreate method creates a new notes table if it already doesn’t exists.</p>
<p>The Database.java class handles the insertion, deletion, update and selection queries. The methods of this class abstracts the native SQLite operations. For example, here is the insertion query.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>    @Override
public void insert(String note) {
    StringBuilder sql = new StringBuilder();
    sql.append(&quot;INSERT&quot;);
    sql.append(&quot; INTO &quot;);
    sql.append(TABLE);
    sql.append(&quot; (note) values (&quot;);
    sql.append(&quot;\&quot;&quot;);
    sql.append(note);
    sql.append(&quot;\&quot;)&quot;);
    execSQL(sql.toString());
}
</pre></div>
</div>
<p>The execSQL method prepares SQL statement to execute SQL queries.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>@Override
public void execSQL(String statement) {
        SQLiteStatement stmt = new SQLiteStatement(statement, null);
        if (stmt.prepare(dbHandle)) {
                if (!stmt.exec()) {
                        System.err.println(&quot;Error executing - &quot; + stmt.getLastError());
                }
        } else {
                System.err.println(&quot;Error executing - &quot; + stmt.getLastError());
                System.err.println(&quot;\tin: &quot; + stmt.getStatement());
        }
}
</pre></div>
</div>
<p>The SQLiteStatement.java handles the native routines of the SQLite libraries like prepare(), exec(), query(), strep(), close(). This class uses the native C API calls that were generated using the binding generator. The following snippets show how prepare() and exec() methods are implemented.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>public boolean prepare(VoidPtr dbHandle) {
        if (dbHandle == null) {
                throw new NullPointerException();
        }
        this.dbHandle = dbHandle;
        @SuppressWarnings(&quot;unchecked&quot;)
        Ptr&lt;VoidPtr&gt; stmtRef = (Ptr&lt;VoidPtr&gt;) PtrFactory.newPointerPtr(
                        Void.class, 2, 1, true, false);
        int err = Globals.sqlite3_prepare_v2(dbHandle, statement, -1, stmtRef,
                        null);
        if (err != 0) {
                lastError = Globals.sqlite3_errmsg(dbHandle);
                return false;
        }
        stmtHandle = stmtRef.get();
        int idx = 0;
        for (Object bind : bindArgs) {
                idx++;
                if (bind instanceof String) {
                        err = Globals.sqlite3_bind_text(stmtHandle, idx, (String)bind, -1, new Globals.Function_sqlite3_bind_text(){
                                @Override
                                public void call_sqlite3_bind_text(VoidPtr arg0){}
                        });
                } else if (bind instanceof Integer) {
                        err = Globals.sqlite3_bind_int(stmtHandle, idx,  (Integer) bind);
                } else if (bind instanceof Long) {
                        err = Globals.sqlite3_bind_int64(stmtHandle, idx,  (Long) bind);
                } else if (bind instanceof Double) {
                        err = Globals.sqlite3_bind_double(stmtHandle, idx,  (Double) bind);
                } else if (bind == null) {
                        err = Globals.sqlite3_bind_null(stmtHandle, idx);
                } else {
                        lastError = &quot;No implemented SQLite3 bind function found for &quot; + bind.getClass().getName();
                        return false;
                }
                if (err != 0) {
                        lastError = Globals.sqlite3_errmsg(dbHandle);
                        return false;
                }
        }
        return true;
}

public boolean exec() {
        if (stmtHandle == null) {
                throw new RuntimeException(&quot;statement handle is closed&quot;);
        }
        //LOG.debug(&quot;Execing &quot; + statement);
        int err = Globals.sqlite3_step(stmtHandle);
        if (err == 101 /* SQLITE_DONE */) {
                affectedCount = Globals.sqlite3_changes(dbHandle);
                lastInsertedID = Globals.sqlite3_last_insert_rowid(dbHandle);
        }
        close();
        if (err != 101 /* SQLITE_DONE */) {
                lastError = Globals.sqlite3_errmsg(dbHandle);
                return false;
        }
        return true;
}
</pre></div>
</div>
<p>Based on this, we can implement different methods of the sqlite statement class.</p>
<p>The SQLiteCursor.java class handles the data extraction APIs from the statement class. Following are methods to get integer and string values from the query executed.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>@Override
public String getString(int i) {
        if (stmt == null) {
                throw new RuntimeException(&quot;statement is closed&quot;);
        }
        return Globals.sqlite3_column_text(stmt.getStmtHandle(), i);
}
@Override
public int getInt(int i) {
        if (stmt == null) {
                throw new RuntimeException(&quot;statement is closed&quot;);
        }
        return Globals.sqlite3_column_int(stmt.getStmtHandle(), i);
}
</pre></div>
</div>
<p>Android has its own version of SQLite that has a slightly different implementation than the native one. This limits our ability to reuse the code between the platforms. For this reason, we will build our own custom version of SQLite for Android using NatJ bindings. A dynamic shared object library of the native SQLite is created which is linked at runtime so Android could handle the native C calls of SQLite. Along with the sqlite.so library, two more libraries are linked with the project. They are libnatj.so and libc++_shared.so. The libnatj.so is a NatJ bridge to work with the NatJ calls of Multi-OS Engine. The libc++_shared.so is shipped to support Android 4.x. It is not needed for Android 5.x.</p>
<img alt="../../../_images/part24.png" src="../../../_images/part24.png" />
<p>In the build.gradle file, we have to make changes so that we can use of the .so native libs.</p>
<p>First we have to specify the src directory for jnilibs in the sourceSets</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>    sourceSets {
    main {
        manifest.srcFile &#39;src/main/AndroidManifest.xml&#39;
        java.srcDir &#39;src&#39;
        res.srcDir &#39;res&#39;
        assets.srcDir &#39;assets&#39;
        jniLibs.srcDir &#39;src/main/native-libs&#39;
        jni.srcDirs = []           //disable automatic ndk-build call
    }
}
</pre></div>
</div>
<p>Next we create jar file of the native libs.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>task nativeLibsToJar(type: Zip, description: &#39;create a jar archive of the native libs&#39;) {
destinationDir file(&quot;$buildDir/native-libs&quot;)
baseName &#39;native-libs&#39;
extension &#39;jar&#39;
from fileTree(dir: &#39;src/main/native-libs&#39;, include: &#39;**/*.so&#39;)
into &#39;lib/&#39;
}
</pre></div>
</div>
<p>We compile and build that jar:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>tasks.withType(org.gradle.api.tasks.compile.JavaCompile) {
compileTask -&gt; compileTask.dependsOn nativeLibsToJar
}
clean.dependsOn &#39;cleanCopyNativeLibs&#39;
tasks.withType(com.android.build.gradle.tasks.PackageApplication) {
pkgTask -&gt;
        pkgTask.jniFolders = new HashSet()
        pkgTask.jniFolders.add(new File(buildDir, &#39;native-libs&#39;))
}
</pre></div>
</div>
<p>iOS has a built-in SQLite native version which can be directly used without any linking of libraries.</p>
<p>Next we create platform specific code for iOS and Android to make the database calls.</p>
<div class="section" id="ios-specific-code">
<h2>iOS Specific Code<a class="headerlink" href="#ios-specific-code" title="Permalink to this headline">¶</a></h2>
<p>A SQLiteDatabaseHelper class is created which extends the SQLiteDatabaseHelper common class. Only the getDocumentsPath() method of this class is overridden to get the iOS specific documents directory path.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>@Override
protected String getDocumentsPath() {
        NSArray paths = Foundation.NSSearchPathForDirectoriesInDomains(
                        NSSearchPathDirectory.DocumentDirectory,
                        NSSearchPathDomainMask.UserDomainMask, true);
        return (String) paths.firstObject();
}
</pre></div>
</div>
<p>In the viewDidLoad() method of MasterViewController, an instance of databasehelper is created in whose constructor filepath of the database is passed. An instance of Database is created and its reference is retrieved by getWritableDatabase() method.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>    @Override
@Selector(&quot;viewDidLoad&quot;)
public void viewDidLoad() {
        // Do any additional setup after loading the view, typically from a nib.
        navigationItem().setLeftBarButtonItem(editButtonItem());
        ISQLiteDatabaseHelper helper = new SQLiteDatabaseHelper(dbFileName);
        db = helper.getWritableDatabase();
        }
</pre></div>
</div>
<p>A listener method is added to the add button in which we execute database insertion query.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>    @Selector(&quot;insertNewObject:&quot;)
public void insertNewObject(Object sender){
    db.insert(defaultText);
    makeObjects();
    NSIndexPath indexPath = NSIndexPath.indexPathForRowInSection(0,0);
    tableView().insertRowsAtIndexPathsWithRowAnimation((NSArray) NSArray.arrayWithObject(indexPath), UITableViewRowAnimation.Automatic);
    performSegueWithIdentifierSender(&quot;showDetail&quot;, this);
}
</pre></div>
</div>
<p>In DetailViewController, changes to the default text are updated with the update API call and note is deleted if the text is left blank.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>    @Selector(&quot;doSaveNote:&quot;)
public void doSaveNote( Object sender){
    if (detailNote == null || db == null) {
        return;
    }
    if(!dataText.text().equals(&quot;&quot;)){
        detailNote.setNote(dataText.text());
        db.update(detailNote);
    }else{
        db.delete(detailNote.getId());
    }
}
</pre></div>
</div>
</div>
<div class="section" id="android-specific-code">
<h2>Android Specific Code<a class="headerlink" href="#android-specific-code" title="Permalink to this headline">¶</a></h2>
<p>Like iOS, an AndroidDatabaseHelper class is created which overrides the getDocumentsPath() to pass the directory path of the Android SQLite file.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>@Override
protected String getDocumentsPath() {
        return Environment.getExternalStorageDirectory().getPath();
}
</pre></div>
</div>
<p>Also similar to iOS, the databasehelper and database instances are created in the iOS counterpart of viewDidLoad() method (in onCreate() method of MainActivity.java).</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>     @Override
protected void onCreate(Bundle savedInstanceState) {
    super.onCreate(savedInstanceState);
    setContentView(R.layout.activity_main);
    SQLiteDatabaseHelper dbHelper = new AndroidSQLiteDatabaseHelper(AndroidSQLiteDatabaseHelper.DB_NAME);
    db = dbHelper.getWritableDatabase();

    }
</pre></div>
</div>
<p>The listener method is added to the add button method to insert in the database.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>    public void insertNewObject() {
   db.insert(DEFAULT_TEXT);
   makeObjects();
}
</pre></div>
</div>
<p>EditorActivity.java calls the update and delete queries according to the user input.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>    private void finishEditing() {
    String newText = editor.getText().toString().trim();
    if(newText.equals(&quot;&quot;)){
        newText = DEFAULT_TEXT;
        db.delete(noteId);
    }
    else if(!newText.equals(note)){
        noteDetail.setNote(newText);
        db.update(noteDetail);
    }
    finish();
}
</pre></div>
</div>
<p>Run the app so you can see the database files created in your respective platforms.</p>
<p>This method allows the business logic of the code can be reused on both the platforms using the same implementation of SQLite. This definitely saves a lot of coding effort and helps minimize code maintenance.</p>
<div class="toctree-wrapper compound">
<ul class="simple">
</ul>
</div>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../../8_accessWebServices/accessWebServices.html" class="btn btn-neutral float-right" title="Accessing Web Services" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../1_part1/part1.html" class="btn btn-neutral" title="Working with Persistent Storage Using the Multi-OS Engine Technology Preview - Part 1" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, Intel Corporation.

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'1.0.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>